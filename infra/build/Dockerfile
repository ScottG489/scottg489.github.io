FROM ubuntu:24.04@sha256:cd1dba651b3080c3686ecf4e3c4220f026b521fb76978881737d24f200828b2b

ARG BUILD_USER=ubuntu
ENV HOME=/home/${BUILD_USER}

RUN apt-get update && \
  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
  ca-certificates=20240203 \
  git=1:2.43.0-1ubuntu7 \
  openssh-client=1:9.6p1-3ubuntu13 \
  jq=1.7.1-3ubuntu0.24.04.1 \
  curl=8.5.0-2ubuntu10.6 \
  unzip=6.0-28ubuntu4 \
  # Required for Cypress \
  libgtk-3-0t64=3.24.41-4ubuntu1 \
  libgbm-dev=25.2.8-0ubuntu0.24.04.1 \
  libnotify-dev=0.8.3-1build2 \
  libnss3=2:3.98-1build1 \
  libxss1=1:1.2.3-1build3 \
  libasound2t64=1.2.11-1ubuntu0.1 \
  libxtst6=2:1.2.3-1.1build1 \
  xauth=1:1.1.2-1build1 \
  xvfb=2:21.1.12-1ubuntu1 \
   && apt-get clean \
   && rm -rf /var/lib/apt/lists/*

ARG AWSCLI_VERSION=2.33.17
RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64-$AWSCLI_VERSION.zip" -o "awscliv2.zip" && \
  unzip awscliv2.zip && \
  ./aws/install && \
  rm -rf aws awscliv2.zip

ARG TERRAFORM_VERSION=1.14.4
RUN curl https://releases.hashicorp.com/terraform/$TERRAFORM_VERSION/terraform_${TERRAFORM_VERSION}_linux_amd64.zip -o /tmp/terraform.zip && \
  unzip -d /usr/local/bin /tmp/terraform.zip && \
  rm /tmp/terraform.zip

ARG HADOLINT_VERSION=2.14.0
RUN curl -L https://github.com/hadolint/hadolint/releases/download/v$HADOLINT_VERSION/hadolint-Linux-x86_64 \
    -o /usr/local/bin/hadolint \
    && chmod +x /usr/local/bin/hadolint

USER ${BUILD_USER}

ARG NVM_VERSION=0.40.3
ARG NODE_VERSION=24.13.0
ENV NODE_VERSION=$NODE_VERSION
ENV NVM_DIR=${HOME}/.nvm

# Install nvm with node and npm
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
RUN curl https://raw.githubusercontent.com/nvm-sh/nvm/v${NVM_VERSION}/install.sh | bash
RUN . $NVM_DIR/nvm.sh \
    && nvm alias default $NODE_VERSION \
    && nvm use default

RUN mkdir -p ${HOME}/.ssh \
    && mkdir -p ${HOME}/.docker \
    && mkdir -p ${HOME}/.aws \
    && mkdir -p ${HOME}/build

COPY known_hosts ${HOME}/.ssh/known_hosts
COPY config ${HOME}/.aws/config
COPY gitconfig ${HOME}/.gitconfig
COPY run.sh ${HOME}/build/run.sh
COPY run-test.sh ${HOME}/build/run-test.sh
COPY build_functions.sh ${HOME}/build/build_functions.sh

WORKDIR ${HOME}/build
ENTRYPOINT ["./run.sh"]
